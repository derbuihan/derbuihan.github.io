<!DOCTYPE html>
<html lang="ja">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.107.0">


<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/dsrkafuu/dsr-cdn-main@1/images/favicons/dsrca.ico" />



<title>PyTorchを用いて三角ゲームを解いてみた。 - derbuihan blog</title>


<meta name="author" content="derbuihan" />


<meta name="description" content="derbuihan blog" />


<meta name="keywords" content="pytorch, python" />


<meta property="og:title" content="PyTorchを用いて三角ゲームを解いてみた。" />
<meta name="twitter:title" content="PyTorchを用いて三角ゲームを解いてみた。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://derbuihan.github.io/posts/pytorch_triangle_game/" /><meta property="og:description" content="先日、三角ゲームというゲームを知った。 今回はこのゲームをPytorchを用いて解いてみた。 三角ゲームの説明 はじめに三角ゲームについて説明する。 例として$n=5$人($A, B, C, D, E$)で遊ぶ場合を説明す" />
<meta name="twitter:description" content="先日、三角ゲームというゲームを知った。 今回はこのゲームをPytorchを用いて解いてみた。 三角ゲームの説明 はじめに三角ゲームについて説明する。 例として$n=5$人($A, B, C, D, E$)で遊ぶ場合を説明す" /><meta property="og:image" content="https://derbuihan.github.io/img/og.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://derbuihan.github.io/img/og.png" /><meta property="article:published_time" content="2022-05-15T14:59:38+09:00" /><meta property="article:modified_time" content="2022-05-15T14:59:38+09:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>




<link rel="stylesheet" href="https://derbuihan.github.io/assets/css/fuji.min.css" />





<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-106862529-8');
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106862529-8"></script>





</head>

<body
  data-theme="light"
  data-theme-auto='false'
  >
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://derbuihan.github.io/">derbuihan blog</a>
            
            <span class="title-sub">derbuihan blog</span>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://derbuihan.github.io/posts/pytorch_triangle_game/">PyTorchを用いて三角ゲームを解いてみた。</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2022-05-15</span>

<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;1592 字</span>

<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/pytorch">pytorch</a>&nbsp;<a href="/tags/python">python</a>&nbsp;</span>

    </div>
    
    <div class="post-content markdown-body">
        <p>先日、三角ゲームというゲームを知った。
今回はこのゲームをPytorchを用いて解いてみた。</p>
<h3 id="三角ゲームの説明">三角ゲームの説明</h3>
<p>はじめに三角ゲームについて説明する。
例として$n=5$人($A, B, C, D, E$)で遊ぶ場合を説明する。</p>
<p>ゲームを始める前にそれぞれのプレイヤーは、自分以外の異なる２人のプレイヤーを選択する。
ここでは、$A = (B, C)$, $B = (A, C)$, $C = (B, D)$, $D = (C, E)$, $E = (C, D)$を選んだとする。
それぞれのプレイヤーは選択したプレイヤーと正三角形を作るように移動を行う。
最終的にこの条件をなるべく満たしながら最も多くの正三角形を作成することがこのゲームの目標である。</p>
<p>この例では以下のようにそれぞれのプレイヤーが移動すれば、すべての条件を満たし最大の5個の正三角形が作成出来る。</p>
<p><img class="img-zoomable" src="/img/pytorch_triangle_game/n5_example.png" alt="n=5の例" />
</p>
<h3 id="pytorchを使って解く">PyTorchを使って解く</h3>
<p>このゲームをPyTorchを用いて解いてみる。</p>
<h4 id="ライブラリのインポート">ライブラリのインポート</h4>
<p>はじめに、準備としてライブラリのインポートと保存用の関数を用意。</p>
<pre><code class="language-Python">import torch
from torch import norm, dot, abs

from random import randrange, random
import matplotlib.pyplot as plt

def savefig(xs, ys, i):
  plt.figure(figsize=(8,8))
  plt.xlim([-0.5, 1.5])
  plt.ylim([-0.5, 1.5])
  plt.scatter(xs, ys, marker=&quot;.&quot;)
  plt.savefig(&quot;fig/fig&quot;+str(i).zfill(5)+&quot;.png&quot;)
  plt.close()
</code></pre>
<p>importでerrorが出たら<code>pip3 install torch matplotlib</code>する。
<code>savefig(xs, ys, i)</code>は、座標のリスト<code>(xs, ys)</code>を取得して、図を作成し<code>fig/fig000i.png</code>に保存する。</p>
<h4 id="ゲームの準備">ゲームの準備</h4>
<p>次はゲームの準備を行う。</p>
<p>まず条件を決定する。
今回は自分以外の異なる二人のプレイヤーをランダムに選ぶ。</p>
<pre><code class="language-Python"># determine conditions
n = 10 # プレイヤーの人数

conditions = []
for i in range(n):
  a, b = randrange(n), randrange(n)
  while a == i or b == i or a == b:
    a, b = randrange(n), randrange(n)
  conditions.append([a, b])
conditions = torch.tensor(conditions)
</code></pre>
<p>最終的に<code>conditions.shape = (n, 2)</code>である。
<code>conditions[i]=[a, b]</code>はプレイヤー$i$はプレイヤー$a, b$と正三角形を作成するという条件である。</p>
<p>次に、それぞれのプレイヤーの初期位置を設定する。</p>
<pre><code class="language-Python"># initial positons
pos = torch.tensor([[0.8*random() + 0.1 for _ in range(2)] for _ in range(n)], requires_grad=True) 
</code></pre>
<p>$x$座標も$y$座標も0.1~0.9の範囲で一様分布になるように定めている。
また、後に位置を自動微分を用いて位置を調整するので、<code>requires_grad=True</code>を設定しておく。</p>
<h4 id="損失関数の定義">損失関数の定義</h4>
<p>損失関数を定義し、この関数が最小(<code>0</code>)になったとき、すべての条件が満たされ正三角形が最大個数生成される。</p>
<pre><code class="language-Python"># define loss 
def loss_func(pos):
  loss = torch.sum(torch.where(pos&gt;1, pos-1, torch.zeros(pos.shape)))
  loss += torch.sum(torch.where(pos&lt;0, -pos, torch.zeros(pos.shape)))
  for i, [a, b] in enumerate(conditions):
    x, y, z = pos[i], pos[a], pos[b]
    loss += abs(dot(y-x, z-x)/norm(y-x)/norm(z-x) - 0.5)
    loss += abs(dot(z-y, x-y)/norm(z-y)/norm(x-y) - 0.5)
    loss += abs(dot(x-z, y-z)/norm(x-z)/norm(y-z) - 0.5)
  return loss
</code></pre>
<p>はじめの二行は座標が0-1の範囲に収まるように加えている。
あとは条件の三角形のすべての角度が60°になるように設定している。</p>
<h4 id="最適化">最適化</h4>
<p>すべてのプレイヤーの位置<code>pos</code>を、損失関数<code>loss_func</code>が最小になるように最小化して最適化を行う。</p>
<pre><code class="language-Python"># train
trace = [] # to trace loss
opt = torch.optim.Adam([pos], lr=0.01)
for i in range(100):
  xs = pos[:, 0].detach().numpy() # to numpy 
  ys = pos[:, 1].detach().numpy() # to numpy
  savefig(xs, ys, i) # save fig

  opt.zero_grad()
  loss = loss_func(pos)

  trace.append(loss.item()) # trace loss
  loss.backward()

  opt.step()
</code></pre>
<p><code>Adam</code>を用いて<code>pos</code>を最適化する。
<code>loss_func</code>がPyTorchの関数のみで構成されているため、<code>pos</code>の自動微分を行うことができ効率的に最小化出来る。</p>
<h4 id="可視化">可視化</h4>
<p><code>trace</code>と<code>pos</code>を可視化する。</p>
<pre><code class="language-Python"># plot trace
plt.plot(trace)

# plot pos
plt.figure(figsize=(4,4))
plt.xlim([-0.5, 1.5]);plt.ylim([-0.5, 1.5]);
xs = pos[:, 0].detach().numpy()
ys = pos[:, 1].detach().numpy()
plt.scatter(xs, ys, marker=&quot;.&quot;)
</code></pre>
<p><img class="img-zoomable" src="/img/pytorch_triangle_game/n10_loss.png" alt="n=10のloss" />

<img class="img-zoomable" src="/img/pytorch_triangle_game/n10_pos.png" alt="n=10のpos" />
</p>
<p><code>conditions = [[9, 8],[8, 6],[7, 9],[2, 1],[6, 3],[6, 1],[0, 2],[8, 1],[2, 7],[6, 4]]</code></p>
<p>また、<code>fig/</code>に保存した画像たちは<code>$convert fig/fig*0.png out.gif</code>を用いてgif動画に変換出来る。</p>
<h4 id="その他の結果">その他の結果</h4>
<p>$n=10$の場合と$n=100$の場合に実験を行い、動画の作成してYouTubeにアップロードした。</p>
<ol>
<li><a href="https://www.youtube.com/shorts/GvD7jDyWv68" target="_blank">n=10の例</a></li>
<li><a href="https://www.youtube.com/shorts/SE2WmLegfBA" target="_blank">n=100の例</a></li>
</ol>
<p>この動画の$n=10$の場合は上手に最適化されてすべての条件を満たしている、$n=100$の場合は何がなんだかよくわからない。</p>
<h3 id="感想">感想</h3>
<ul>
<li>自動微分を用いて三角ゲームの最適化を行った。</li>
<li>今回の問題は必ず答えがあるわけではないので結果は微妙になってしまったが、損失関数を調整することで目に見えるいい結果が得られるかもしれないと思った。</li>
<li>自動微分は機械学習のモデルを最適化するためによく使われているが、他にも色々な遊び方がありそうだと思ったのでこういうゲームを解いてみた。</li>
<li>微分可能プログラミングも勉強してみたい。</li>
</ul>

    </div>
</article>




            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>ページ</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/works/">Works</a>
            </li>
            
            <li>
                <a href="/search/">Search</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>リンク</h3>
        <ul>
            
            <li>
                <a href="https://github.com/derbuihan" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://twitter.com/derbuihan" target="_blank"><span>Twitter</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>タグ</h3>
        <div>
            
            <span>
                <a href="/tags/atom/">Atom</a>
            </span>
            
            <span>
                <a href="/tags/bash/">Bash</a>
            </span>
            
            <span>
                <a href="/tags/bootstrap/">Bootstrap</a>
            </span>
            
            <span>
                <a href="/tags/coq/">Coq</a>
            </span>
            
            <span>
                <a href="/tags/datasets/">Datasets</a>
            </span>
            
            <span>
                <a href="/tags/digestauth/">DigestAuth</a>
            </span>
            
            <span>
                <a href="/tags/docker/">docker</a>
            </span>
            
            <span>
                <a href="/tags/elm/">Elm</a>
            </span>
            
            <span>
                <a href="/tags/emacs/">Emacs</a>
            </span>
            
            <span>
                <a href="/tags/gitlab/">GitLab</a>
            </span>
            
            <span>
                <a href="/tags/gpu/">gpu</a>
            </span>
            
            <span>
                <a href="/tags/haskell/">Haskell</a>
            </span>
            
            <span>
                <a href="/tags/hugo/">Hugo</a>
            </span>
            
            <span>
                <a href="/tags/js/">JS</a>
            </span>
            
            <span>
                <a href="/tags/kernel/">kernel</a>
            </span>
            
            <span>
                <a href="/tags/linux/">Linux</a>
            </span>
            
            <span>
                <a href="/tags/minisat/">MiniSat</a>
            </span>
            
            <span>
                <a href="/tags/python/">Python</a>
            </span>
            
            <span>
                <a href="/tags/pytorch/">pytorch</a>
            </span>
            
            <span>
                <a href="/tags/review/">review</a>
            </span>
            
            <span>
                <a href="/tags/sat/">SAT</a>
            </span>
            
            <span>
                <a href="/tags/tailwindcss/">TailwindCSS</a>
            </span>
            
            <span>
                <a href="/tags/tcp/">TCP</a>
            </span>
            
            <span>
                <a href="/tags/tensorflow/">tensorflow</a>
            </span>
            
            <span>
                <a href="/tags/tex/">Tex</a>
            </span>
            
            <span>
                <a href="/tags/vps/">VPS</a>
            </span>
            
            <span>
                <a href="/tags/%E6%95%B0%E5%AD%A6/">数学</a>
            </span>
            
            <span>
                <a href="/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92/">機械学習</a>
            </span>
            
            <span>
                <a href="/tags/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/">環境構築</a>
            </span>
            
            <span>
                <a href="/tags/%E7%9B%B8%E8%BB%A2%E7%A7%BB/">相転移</a>
            </span>
            
            <span>
                <a href="/tags/%E7%B4%A0%E6%95%B0/">素数</a>
            </span>
            
        </div>
    </div>
    
</aside>

        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>ページ</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/works/">Works</a>
            </li>
            
            <li>
                <a href="/search/">Search</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>リンク</h3>
        <ul>
            
            <li>
                <a href="https://github.com/derbuihan" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://twitter.com/derbuihan" target="_blank"><span>Twitter</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>タグ</h3>
        <div>
            
            <span>
                <a href="/tags/atom/">Atom</a>
            </span>
            
            <span>
                <a href="/tags/bash/">Bash</a>
            </span>
            
            <span>
                <a href="/tags/bootstrap/">Bootstrap</a>
            </span>
            
            <span>
                <a href="/tags/coq/">Coq</a>
            </span>
            
            <span>
                <a href="/tags/datasets/">Datasets</a>
            </span>
            
            <span>
                <a href="/tags/digestauth/">DigestAuth</a>
            </span>
            
            <span>
                <a href="/tags/docker/">docker</a>
            </span>
            
            <span>
                <a href="/tags/elm/">Elm</a>
            </span>
            
            <span>
                <a href="/tags/emacs/">Emacs</a>
            </span>
            
            <span>
                <a href="/tags/gitlab/">GitLab</a>
            </span>
            
            <span>
                <a href="/tags/gpu/">gpu</a>
            </span>
            
            <span>
                <a href="/tags/haskell/">Haskell</a>
            </span>
            
            <span>
                <a href="/tags/hugo/">Hugo</a>
            </span>
            
            <span>
                <a href="/tags/js/">JS</a>
            </span>
            
            <span>
                <a href="/tags/kernel/">kernel</a>
            </span>
            
            <span>
                <a href="/tags/linux/">Linux</a>
            </span>
            
            <span>
                <a href="/tags/minisat/">MiniSat</a>
            </span>
            
            <span>
                <a href="/tags/python/">Python</a>
            </span>
            
            <span>
                <a href="/tags/pytorch/">pytorch</a>
            </span>
            
            <span>
                <a href="/tags/review/">review</a>
            </span>
            
            <span>
                <a href="/tags/sat/">SAT</a>
            </span>
            
            <span>
                <a href="/tags/tailwindcss/">TailwindCSS</a>
            </span>
            
            <span>
                <a href="/tags/tcp/">TCP</a>
            </span>
            
            <span>
                <a href="/tags/tensorflow/">tensorflow</a>
            </span>
            
            <span>
                <a href="/tags/tex/">Tex</a>
            </span>
            
            <span>
                <a href="/tags/vps/">VPS</a>
            </span>
            
            <span>
                <a href="/tags/%E6%95%B0%E5%AD%A6/">数学</a>
            </span>
            
            <span>
                <a href="/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92/">機械学習</a>
            </span>
            
            <span>
                <a href="/tags/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/">環境構築</a>
            </span>
            
            <span>
                <a href="/tags/%E7%9B%B8%E8%BB%A2%E7%A7%BB/">相転移</a>
            </span>
            
            <span>
                <a href="/tags/%E7%B4%A0%E6%95%B0/">素数</a>
            </span>
            
        </div>
    </div>
    
    
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <span>&copy; 2022-2022
                <a href="https://derbuihan.github.io/">derbuihan</a>
                 | <a href="https://github.com/derbuihan/">Source code</a> 
                | Powered by <a href="https://github.com/dsrkafuu/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="/assets/js/fuji.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" />
<script src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"></script>
<script>
  renderMathInElement(document.querySelector('div.content'), {
    delimiters: [
      { left: '$$', right: '$$', display: true },
      { left: '\\[', right: '\\]', display: true },
      { left: '$', right: '$', display: false },
      { left: '\\(', right: '\\)', display: false },
    ],
  });
</script>




</body>

</html>
